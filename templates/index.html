<!-- templates/index.html — God Mode +++ (accessible, responsive, SEO, perf) -->
<!DOCTYPE html>
<html lang="en">

<script src="/static/js/connect.js" defer></script>
<head>
  <meta charset="utf-8" />
  <title>Track AI — Connect Shopify & Pinterest (Install Once, Verify Fast)</title>
  <meta name="store-url" content="{{ store_url or '' }}">
  <meta name="store-id" content="{{ store_id or '' }}">
  <meta name="description" content="Connect your Shopify store and Pinterest tag in minutes. Save credentials, install an idempotent ScriptTag once, and verify integration with built-in tests." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4f6cff" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="canonical" href="/" />

  <!-- Open Graph -->
  <meta property="og:title" content="Track AI — Connect Shopify & Pinterest" />
  <meta property="og:description" content="Install the Pinterest ScriptTag exactly once. No duplicate installs. Built-in verification." />
  <meta property="og:type" content="website" />

  <style>
    /* ===== Design Tokens ===== */
    :root{
      --primary:#4f6cff; --primary-2:#76a0ff; --bg:#f3f7ff; --card:#ffffff;
      --ink:#0b1533; --muted:#667187; --success:#0a7d2b; --error:#b00020; --warn:#9a5a00;
      --ring:0 0 0 3px rgba(79,108,255,.18);
      --border:#d8dfef; --card-shadow:0 12px 40px rgba(16,38,100,.12);
      --radius:16px; --radius-sm:10px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1020; --card:#10172a; --ink:#e7ebf5; --muted:#a9b1c6; --border:#2a3552; }
      body{ background:linear-gradient(135deg,#0b1020 0%,#0f1a33 100%); }
    }

    /* ===== Base ===== */
    *,*::before,*::after{ box-sizing:border-box }
    html:focus-within{ scroll-behavior:smooth }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); background:linear-gradient(135deg,var(--bg) 0%, #fbf9ff 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{ color:inherit }
    .container{ max-width:1100px; margin:32px auto; padding:0 16px }

    /* ===== Header/Nav ===== */
    header{ display:flex; justify-content:center; margin-bottom:16px }
    .nav{
      display:flex; gap:10px; align-items:center; justify-content:center;
      background:rgba(79,108,255,.05); padding:8px; border-radius:12px;
    }
    .nav a{
      text-decoration:none; font-weight:600; padding:.5rem .9rem; border-radius:10px;
      color:var(--ink); transition:transform .15s ease;
    }
    .nav a:hover{ transform:translateY(-1px) }
    .nav a[aria-current="page"]{
      background:linear-gradient(90deg,var(--primary),var(--primary-2)); color:#fff;
    }

    /* ===== Main Grid ===== */
    main.grid{
      display:grid; gap:20px; grid-template-columns: minmax(0,1.2fr) minmax(0,.8fr);
    }
    @media (max-width: 900px){ main.grid{ grid-template-columns:1fr } }

    /* ===== Card ===== */
    .card{
      background:var(--card); border-radius:var(--radius); padding:22px; box-shadow:var(--card-shadow);
    }
    h1{ margin:.2rem 0 .6rem; font-size:1.9rem; line-height:1.2; }
    h2,h3{ margin:0 0 .4rem }
    p.sub{ color:var(--muted); margin:0 0 1rem }
    .divider{ height:1px; background:var(--border); margin:18px 0 }

    /* ===== Forms ===== */
    label{ display:block; font-weight:600; margin-top:14px }
    .row{ position:relative }
    input,button,select{
      width:100%; padding:12px; border-radius:var(--radius-sm);
      border:1px solid var(--border); background:#f9fbff; font-size:15px; transition:.15s;
    }
    input:focus,select:focus{
      outline:none; box-shadow:var(--ring); background:#fff; border-color:#bcd1ff;
    }
    input[aria-invalid="true"]{ border-color:var(--error) }
    .hint{ font-size:.88rem; color:var(--muted); margin-top:4px }
    .field-actions{ position:absolute; right:8px; top:8px; display:flex; gap:6px }

    /* ===== Buttons ===== */
    .stack{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{
      border:0; color:#fff; background:linear-gradient(90deg,var(--primary),var(--primary-2));
      font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(79,108,255,.22);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform:translateY(-1px) }
    .btn:active{ transform:translateY(0) scale(.98) }
    .btn.secondary{ background:#eef2ff; color:#1e2a6d; border:1px solid #c9d3ff }
    .btn.ghost{ background:transparent; border:1px solid var(--border); color:#2c3b6f }
    .btn.danger{ background:#fff0f0; color:var(--error); border:1px solid #ffd1d1 }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .mini{ font-size:.86rem; padding:.45rem .6rem; border-radius:8px }

    /* ===== Status ===== */
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-weight:700;
      padding:.35rem .55rem; border-radius:999px; font-size:.82rem;
    }
    .ok{ background:#e8f7ee; color:var(--success) }
    .warn{ background:#fff6e8; color:var(--warn) }
    .err{ background:#feecef; color:var(--error) }
    .info{ background:#eef3ff; color:#1f2a6d }
    .muted{ color:var(--muted) }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }

    /* ===== Webhook Box ===== */
    .copy-wrap{ position:relative }
    .copy-btn{ position:absolute; right:8px; top:8px }

    /* ===== Toast ===== */
    .toast{
      position:fixed; right:18px; bottom:18px; min-width:260px; padding:12px 14px;
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.18); display:none;
      background:#101828; color:#fff;
    }

    /* ===== Motion Pref ===== */
    @media (prefers-reduced-motion: reduce){
      *,*::before,*::after{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important; }
    }

    /* Utility */
    .visually-hidden{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;
    }
  </style>
</head>
<body>
  <a href="#main" class="visually-hidden">Skip to main content</a>

  <header aria-label="Primary">
    <nav class="nav" aria-label="Main navigation">
      <a href="/" aria-current="page">Connect</a>
      <a href="/status">Status</a>
      <a href="/dashboard">Dashboard</a>
    </nav>
  </header>

  <div class="container">
    <main id="main" class="grid" role="main">
      <!-- LEFT: Connect + Install + Verify -->
      <section class="card" aria-labelledby="connect-title">
        <h1 id="connect-title">Track AI — Connect</h1>
        <p class="sub">Securely connect your Shopify store and Pinterest tag, then install the script <strong>exactly once</strong>.</p>
 
        <!-- STEP 1: CONNECT -->
        <h2 id="step1">1) Save credentials</h2>
        <form id="connectForm" method="post" action="/connect" autocomplete="off" novalidate aria-describedby="connectHelp connectMsg">
          <label for="shopify_store_url">Shopify Store URL</label>
          <div class="row">
            <input 
              type="url" 
              name="shopify_store_url" 
              id="shopify_store_url" 
              required
              placeholder="https://yourstore.myshopify.com" 
              inputmode="url"
              aria-describedby="help-store"
              value="{{ store_url or '' }}"
            />
            <input type="hidden" id="store_id" value="{{ store_id or '' }}">
            <div class="hint" id="help-store">
              Use your canonical domain (e.g. <span class="mono">https://mystore.myshopify.com</span>).
            </div>
          </div>
        </form>


          <label for="shopify_api_key">Shopify Admin API Access Token</label>
          <div class="row">
            <input type="password" name="shopify_api_key" id="shopify_api_key" required
                   placeholder="shpat_***" autocomplete="new-password" aria-describedby="help-token" />
            <div class="field-actions" aria-hidden="true">
              <button type="button" class="btn ghost mini" id="revealShpat" title="Reveal/Hide token">Reveal</button>
              <button type="button" class="btn ghost mini" id="copyShpat" title="Copy token">Copy</button>
            </div>
            <div class="hint" id="help-token">Create under <em>Settings → Apps and sales channels → Develop apps</em>. Keep it secret.</div>
          </div>

          <label for="pinterest_tag_id">Pinterest Tag ID</label>
          <input type="text" name="pinterest_tag_id" id="pinterest_tag_id" required placeholder="e.g. 1234567890" />

          <label for="pinterest_ad_account_id">Pinterest Ad Account ID</label>
          <input type="text" name="pinterest_ad_account_id" id="pinterest_ad_account_id" required placeholder="e.g. 987654321" />

          <div class="stack" style="margin-top:10px">
            <button type="submit" class="btn" id="btnConnect" aria-describedby="connectHelp">🔗 Save Credentials</button>
            <button type="button" class="btn ghost" id="btnRemember" aria-describedby="rememberHelp">💾 Remember inputs</button>
          </div>
          <div class="hint" id="rememberHelp">Optional: stores values locally in this browser (not on the server).</div>

          <div id="connectMsg" class="badge info" role="status" aria-live="polite" style="display:none;margin-top:12px"></div>
          <div id="connectHelp" class="visually-hidden">Use this form to securely save your credentials.</div>
        </form>

        <div class="divider" role="separator" aria-hidden="true"></div>

        <!-- STEP 2: INSTALL SCRIPT TAG (ONCE) -->
        <h2 id="step2">2) Install Pinterest ScriptTag (once)</h2>
        <p class="muted">We’ll verify whether it’s already installed and prevent duplicates automatically.</p>

        <div class="stack" role="group" aria-labelledby="step2">
          <button class="btn" id="btnCheck">🔍 Check Install Status</button>
          <button class="btn secondary" id="btnInstall" aria-disabled="false">⚙️ Install Tag</button>
          <button class="btn danger" id="btnDisconnect">🚫 Disconnect</button>
        </div>
        <div id="installMsg" class="badge info" role="status" aria-live="polite" style="display:none;margin-top:12px"></div>

        <div class="divider" role="separator" aria-hidden="true"></div>

        <!-- STEP 3: VERIFY -->
        <h2 id="step3">3) Verify</h2>
        <div class="stack" role="group" aria-labelledby="step3">
          <button class="btn ghost" id="btnTestShopify">✅ Test Shopify</button>
          <button class="btn ghost" id="btnTestPinterest">📡 Test Pinterest</button>
          <button class="btn ghost" id="btnTestSheet">🧪 Test Google Sheet</button>
        </div>
        <div id="verifyMsg" class="badge info" role="status" aria-live="polite" style="display:none;margin-top:12px"></div>
      </section>

      <!-- RIGHT: Webhook + Meta -->
      <aside class="card" aria-labelledby="webhook-title">
        <h2 id="webhook-title">Webhook URL</h2>
        <div class="copy-wrap">
          <div class="mono" id="webhook_url" style="padding:12px 38px 12px 12px;border:1px solid var(--border);border-radius:10px;background:#f7f9ff;word-break:break-all;">
            {{ webhook_url }}
          </div>
          <button class="btn ghost mini copy-btn" id="copyWebhook" aria-label="Copy webhook URL">📋 Copy</button>
        </div>
        <p class="hint" style="margin-top:8px">
          Add as <span class="mono">orders/create</span> and <span class="mono">checkouts/create</span> webhooks if desired
          (auto-provision happens when possible).
        </p>

        <div class="divider" role="separator" aria-hidden="true"></div>

        <h3>Tips</h3>
        <ul class="muted" style="margin-top:6px; padding-left:18px; line-height:1.55;">
          <li>“Install Tag” won’t duplicate. We check Shopify ScriptTags and block repeats.</li>
          <li>Use “Remember inputs” for faster re-connect on this browser only.</li>
          <li>If you rotate your Admin API token, re-save credentials — install check remains idempotent.</li>
        </ul>
      </aside>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>
  <noscript><div class="container"><p class="badge warn">JavaScript is required to connect and verify.</p></div></noscript>

  <script>
    // ==== Helpers ====
    const $ = (id) => document.getElementById(id);
    const setBadge = (el, text, kind='info')=>{
      el.style.display='inline-flex'; el.className='badge '+kind; el.textContent=text;
    };
    const clearBadge = (el)=>{ el.style.display='none'; el.textContent=''; };
    const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3400); };

    // Local storage (explicit opt-in)
    const FIELDS = ['shopify_store_url','shopify_api_key','pinterest_tag_id','pinterest_ad_account_id'];
    const loadMemory = ()=>{ FIELDS.forEach(f=>{ const v=localStorage.getItem('trackai:'+f); if(v) $(f).value=v; }); };
    const saveMemory = ()=>{ FIELDS.forEach(f=> localStorage.setItem('trackai:'+f, $(f).value.trim())); toast('Saved locally in your browser.'); };

    // URL normalizer
    const normalizeShopUrl = (url)=>{
      url = (url||'').trim(); if(!url) return '';
      if(!/^https?:\/\//i.test(url)) url = 'https://'+url;
      try{ const u = new URL(url); return `https://${(u.host||'').replace(/\/+$/,'')}`; } catch(_){ return url; }
    };

    // Clipboard
    const copyText = async (t)=>{
      try{ await navigator.clipboard.writeText(t); toast('Copied to clipboard'); }
      catch(_){ toast('Copy failed'); }
    };

    // ==== Init ====
    loadMemory();
    $('btnRemember')?.addEventListener('click', saveMemory);

    // Toggle token visibility
    $('revealShpat')?.addEventListener('click', ()=>{
      const i=$('shopify_api_key'); i.type = (i.type==='password'?'text':'password');
      $('revealShpat').textContent = i.type==='password'?'👁 Reveal':'🙈 Hide';
    });
    $('copyShpat')?.addEventListener('click', ()=> copyText($('shopify_api_key').value));

    // Copy webhook
    $('copyWebhook')?.addEventListener('click', ()=> copyText($('webhook_url').textContent.trim()));

    // Soft validate URL shape
    $('shopify_store_url')?.addEventListener('blur', (e)=>{
      const v = normalizeShopUrl(e.target.value);
      e.target.value = v;
      if(v && !/myshopify\.com$/i.test(v)){
        // Not blocking — many stores use custom domains
        $('shopify_store_url').setAttribute('aria-invalid','false');
      }
    });

    // ==== Connect handler ====
    $('connectForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearBadge($('connectMsg'));

      const form = new FormData(e.target);
      const storeURL = normalizeShopUrl(form.get('shopify_store_url'));
      form.set('shopify_store_url', storeURL);

      // Required field UX
      let invalid = false;
      ['shopify_store_url','shopify_api_key','pinterest_tag_id','pinterest_ad_account_id'].forEach(id=>{
        const el = $(id);
        const missing = !el.value.trim();
        el.setAttribute('aria-invalid', missing ? 'true' : 'false');
        if(missing) invalid = true;
      });
      if(invalid){ setBadge($('connectMsg'),'Please fill all fields','warn'); return; }

      const btn=$('btnConnect'); btn.disabled=true; btn.textContent='Saving…';
      try{
        const resp = await fetch('/connect', { method:'POST', body: new URLSearchParams(form) });
        const html = await resp.text();
        if(resp.ok){
          setBadge($('connectMsg'), '✅ Credentials saved.', 'ok');
          // Extract webhook URL from returned HTML
          const tmp=document.createElement('div'); tmp.innerHTML=html;
          const webhook=tmp.querySelector('#webhook_url');
          if(webhook) $('webhook_url').textContent = webhook.textContent.trim();
          toast('Connected!');
        }else{
          setBadge($('connectMsg'), '❌ Failed to save: '+html.slice(0,180), 'err');
        }
      }catch(err){
        setBadge($('connectMsg'), '❌ Error: '+err, 'err');
      }finally{
        btn.disabled=false; btn.textContent='🔗 Save Credentials';
      }
    });

    // ==== Install status ====
    $('btnCheck')?.addEventListener('click', async ()=>{
      clearBadge($('installMsg'));
      const store = normalizeShopUrl($('shopify_store_url').value);
      const token = $('shopify_api_key').value.trim();
      if(!store || !token){ return setBadge($('installMsg'),'Fill store URL + admin token first.','warn'); }

      $('btnCheck').disabled = true;
      try{
        const res = await fetch('/pixel/install_status',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ store_url: store, admin_token: token })
        });
        const data = await res.json();
        if(data.installed){
          setBadge($('installMsg'), '✅ ScriptTag is already installed.', 'ok');
          $('btnInstall').disabled = true;
          $('btnInstall').setAttribute('aria-disabled','true');
        }else{
          setBadge($('installMsg'), 'Not installed yet.', 'warn');
          $('btnInstall').disabled = false;
          $('btnInstall').setAttribute('aria-disabled','false');
        }
      }catch(_){
        setBadge($('installMsg'),'❌ Status check failed.','err');
      }finally{
        $('btnCheck').disabled = false;
      }
    });

    // ==== Install once ====
    $('btnInstall')?.addEventListener('click', async ()=>{
      clearBadge($('installMsg'));
      const store = normalizeShopUrl($('shopify_store_url').value);
      const token = $('shopify_api_key').value.trim();
      const tag   = $('pinterest_tag_id').value.trim();
      const acct  = $('pinterest_ad_account_id').value.trim();
      const pat   = prompt('Enter your Pinterest Access Token (kept client-side for this call):','');

      if(!store||!token||!tag||!acct||!pat){
        return setBadge($('installMsg'),'Please fill all fields (Pinterest Access Token required).','warn');
      }

      const btn=$('btnInstall'); btn.disabled=true; btn.textContent='Installing…';
      try{
        const res = await fetch('/pixel/install_once',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            shopify_store_url: store,
            shopify_admin_token: token,
            pinterest_tag_id: tag,
            pinterest_ad_account_id: acct,
            pinterest_access_token: pat
          })
        });
        if(res.status===200){
          setBadge($('installMsg'),'✅ Installed successfully.','ok');
          btn.disabled=true; btn.textContent='Installed'; btn.setAttribute('aria-disabled','true');
        }else if(res.status===409){
          const data=await res.json().catch(()=>({}));
          setBadge($('installMsg'), data.message || 'Already installed.','ok');
          btn.disabled=true; btn.textContent='Already installed'; btn.setAttribute('aria-disabled','true');
        }else{
          const data=await res.json().catch(()=>({detail:'Install failed'}));
          setBadge($('installMsg'),'❌ '+(data.detail||data.error||'Install failed'), 'err');
          btn.disabled=false; btn.textContent='⚙️ Install Tag'; btn.setAttribute('aria-disabled','false');
        }
      }catch(err){
        setBadge($('installMsg'),'❌ '+err, 'err');
        btn.disabled=false; btn.textContent='⚙️ Install Tag'; btn.setAttribute('aria-disabled','false');
      }
    });

    // ==== Disconnect ====
    $('btnDisconnect')?.addEventListener('click', async ()=>{
      const store = normalizeShopUrl($('shopify_store_url').value);
      if(!store){ return setBadge($('installMsg'),'Enter store URL to disconnect.','warn'); }
      const form = new URLSearchParams(); form.set('shopify_store_url', store);

      const btn=$('btnDisconnect'); btn.disabled=true; btn.textContent='Disconnecting…';
      try{
        const resp = await fetch('/disconnect',{ method:'POST', body: form });
        if(resp.ok){
          toast('Disconnected.');
          setBadge($('installMsg'),'Disconnected. ScriptTag may remain until removed manually.','warn');
        }else{
          toast('Failed to disconnect');
        }
      }finally{
        btn.disabled=false; btn.textContent='🚫 Disconnect';
      }
    });

    // ==== Verify actions (FIXED: no "connect first" requirement) ====
    $('btnTestShopify')?.addEventListener('click', ()=>{
      const storeUrl = normalizeShopUrl($('shopify_store_url').value);
      if(!storeUrl){
        return setBadge($('verifyMsg'),'Please enter your Shopify Store URL to run the Shopify test.','warn');
      }
      const q = new URLSearchParams({ shopify_store_url: storeUrl }).toString();
      window.location.href = '/test_shopify?'+q;  // backend should accept shopify_store_url
    });

    $('btnTestPinterest')?.addEventListener('click', ()=>{
      const storeUrl = normalizeShopUrl($('shopify_store_url').value);
      const tagId    = $('pinterest_tag_id').value.trim();
      if(!storeUrl || !tagId){
        return setBadge($('verifyMsg'),'Enter Store URL and Pinterest Tag ID to run the Pinterest test.','warn');
      }
      // Accepts store-scoped verification; no internal store_id required
      const q = new URLSearchParams({
        shopify_store_url: storeUrl,
        pinterest_tag_id: tagId
      }).toString();
      window.location.href = '/test_pinterest?'+q;
    });

    $('btnTestSheet')?.addEventListener('click', ()=> window.location.href='/test_google_sheet');
  </script>
</body>
</html>
